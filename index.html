<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ­´å²ã‚¯ã‚¤ã‚ºAI</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; display:flex; justify-content:center; align-items:center; padding:20px; }
.container { background:white; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); padding:40px; max-width:800px; width:100%; text-align:center; position:relative; }
h1 { color:#333; margin-bottom:30px; font-size:2.5em; }
.quiz-section { margin-bottom:30px; }
.question { font-size:1.3em; color:#555; margin-bottom:20px; padding:20px; background:#f8f9fa; border-radius:10px; border-left:5px solid #667eea; }
.answer-input { width:100%; padding:15px; font-size:1.1em; border:2px solid #ddd; border-radius:10px; margin-bottom:20px; transition:border-color 0.3s; }
.answer-input:focus { outline:none; border-color:#667eea; }
.btn { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; padding:15px 30px; font-size:1.1em; border-radius:25px; cursor:pointer; transition:transform 0.3s, box-shadow 0.3s; margin:10px; }
.btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
.btn:disabled { opacity:0.6; cursor:not-allowed; transform:none; }
.result { margin-top:30px; padding:20px; border-radius:10px; text-align:left; line-height:1.6; display:none; }
.result.correct { background:#d4edda; border:1px solid #c3e6cb; color:#155724; }
.result.incorrect { background:#f8d7da; border:1px solid #f5c6cb; color:#721c24; }
.score { font-size:1.2em; margin-bottom:20px; color:#333; }
.loading { display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; margin-left:10px; }
@keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
.question-counter { background:#667eea; color:white; padding:10px 20px; border-radius:20px; margin-bottom:20px; display:inline-block; }
#era-select { position:absolute; top:20px; right:20px; padding:8px 12px; border-radius:10px; border:1px solid #ddd; font-size:1em; }
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ›ï¸ æ­´å²ã‚¯ã‚¤ã‚ºAI</h1>

    <!-- æ™‚ä»£é¸æŠ -->
    <select id="era-select" onchange="filterByEra()">
        <option value="all">å…¨ã¦ã®æ™‚ä»£</option>
    </select>

    <div class="question-counter">
        <span id="current-question-num">1</span> / <span id="total-questions">0</span>
    </div>
    
    <div class="score">
        æ­£è§£æ•°: <span id="correct-count">0</span> / <span id="answered-count">0</span>
    </div>

    <div class="quiz-section">
        <div class="question" id="question-text">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <input type="text" id="user-answer" class="answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
        <button id="submit-btn" class="btn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
        <button id="next-btn" class="btn" onclick="nextQuestion()" style="display:none;">æ¬¡ã®å•é¡Œ</button>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
let allQuestions = [];
let questions = [];
let currentQuestionIndex = 0;
let correctCount = 0;
let answeredCount = 0;

// é…åˆ—ãƒ©ãƒ³ãƒ€ãƒ åŒ–
function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

// CSVèª­ã¿è¾¼ã¿
async function loadQuestionsFromCSV() {
    const response = await fetch('questions.csv');
    let text = await response.text();
    text = text.replace(/^\uFEFF/, ''); // BOMé™¤å»
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    
    const eraIndex = headers.indexOf('æ™‚ä»£');
    const questionIndex = headers.indexOf('å•é¡Œ');
    const answerIndex = headers.indexOf('ç­”ãˆ');
    
    if (eraIndex === -1 || questionIndex === -1 || answerIndex === -1) {
        throw new Error('CSVã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£ã§ã™ã€‚æ™‚ä»£,å•é¡Œ,ç­”ãˆ ã®åˆ—ãŒå¿…è¦ã§ã™ã€‚');
    }

    return lines.slice(1)
        .map(line => line.split(',').map(c => c.trim()))
        .filter(cols => cols.length > Math.max(eraIndex, questionIndex, answerIndex))
        .map(cols => ({
            era: cols[eraIndex],
            question: cols[questionIndex],
            answer: cols[answerIndex]
        }));
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿
document.addEventListener('DOMContentLoaded', async () => {
    allQuestions = await loadQuestionsFromCSV();
    allQuestions = shuffle(allQuestions);
    populateEraSelect();
    questions = [...allQuestions];
    document.getElementById('total-questions').textContent = questions.length;
    displayCurrentQuestion();
    updateCounters();
});

// æ™‚ä»£é¸æŠè‚¢ç”Ÿæˆ
function populateEraSelect() {
    const select = document.getElementById('era-select');
    const eras = [...new Set(allQuestions.map(q => q.era))];
    eras.forEach(era => {
        const option = document.createElement('option');
        option.value = era;
        option.textContent = era;
        select.appendChild(option);
    });
}

// æ™‚ä»£ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ©ãƒ³ãƒ€ãƒ é †ï¼‰
function filterByEra() {
    const selectedEra = document.getElementById('era-select').value;
    if (selectedEra === 'all') questions = [...allQuestions];
    else questions = allQuestions.filter(q => q.era === selectedEra);
    questions = shuffle(questions);
    currentQuestionIndex = 0;
    document.getElementById('total-questions').textContent = questions.length;
    displayCurrentQuestion();
    updateCounters();
}

// ç¾åœ¨ã®å•é¡Œè¡¨ç¤º
function displayCurrentQuestion() {
    if(questions.length === 0){
        document.getElementById('question-text').textContent = 'ã“ã®æ™‚ä»£ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        return;
    }
    const currentQuestion = questions[currentQuestionIndex];
    document.getElementById('question-text').textContent = `[${currentQuestion.era}] ${currentQuestion.question}`;
    document.getElementById('user-answer').value = '';
    document.getElementById('user-answer').focus();
    document.getElementById('submit-btn').style.display = 'inline-block';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('result').style.display = 'none';
}

// ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
function updateCounters() {
    document.getElementById('current-question-num').textContent = questions.length === 0 ? 0 : currentQuestionIndex + 1;
    document.getElementById('correct-count').textContent = correctCount;
    document.getElementById('answered-count').textContent = answeredCount;
}

// å›ç­”é€ä¿¡ï¼ˆã‚ã„ã¾ã„åˆ¤å®šï¼‰
function submitAnswer() {
    const userAnswer = document.getElementById('user-answer').value.trim();
    const currentQuestion = questions[currentQuestionIndex];
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('result');

    submitBtn.disabled = true;
    submitBtn.innerHTML = 'æ¡ç‚¹ä¸­<span class="loading"></span>';

    try {
        const normalize = str => str
            .replace(/[ï¼ˆï¼‰\s]/g, '')   // ä¸¸æ‹¬å¼§ãƒ»ç©ºç™½å‰Šé™¤
            .normalize('NFKC')          // å…¨è§’â†’åŠè§’
            .toLowerCase();             // å°æ–‡å­—åŒ–

        const userNorm = normalize(userAnswer);
        const answerNorm = normalize(currentQuestion.answer);

        // éƒ¨åˆ†ä¸€è‡´ã§ã‚ã„ã¾ã„æ­£è§£
        const isCorrect = answerNorm.includes(userNorm) || userNorm.includes(answerNorm);

        resultDiv.innerHTML = isCorrect 
            ? 'âœ” æ­£è§£ã§ã™ï¼' 
            : `âŒ ä¸æ­£è§£ã§ã™ã€‚ã‚ãªãŸã®å›ç­”ã€Œ${userAnswer}ã€ã¯ã€æ­£ã—ã„ç­”ãˆã€Œ${currentQuestion.answer}ã€ã¨ã¯å°‘ã—è¡¨è¨˜ãŒé•ã„ã¾ã™ã€‚`;

        resultDiv.className = 'result ' + (isCorrect ? 'correct' : 'incorrect');
        resultDiv.style.display = 'block';

        if (isCorrect) correctCount++;
        answeredCount++;
        updateCounters();

        submitBtn.style.display = 'none';
        document.getElementById('next-btn').style.display = 'inline-block';
    } catch(error) {
        console.error(error);
        resultDiv.innerHTML = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
        resultDiv.className = 'result incorrect';
        resultDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'å›ç­”ã™ã‚‹';
    }
}

// æ¬¡ã®å•é¡Œ
function nextQuestion() {
    currentQuestionIndex++;
    if (currentQuestionIndex >= questions.length) {
        showFinalResult();
    } else {
        displayCurrentQuestion();
        updateCounters();
    }
}

// æœ€çµ‚çµæœ
function showFinalResult() {
    const container = document.querySelector('.container');
    const percentage = Math.round((correctCount / answeredCount) * 100);
    
    container.innerHTML = `
        <h1>ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h1>
        <div class="score" style="font-size:2em; margin:30px 0;">
            æ­£è§£æ•°: ${correctCount} / ${answeredCount} (${percentage}%)
        </div>
        <div style="font-size:1.2em; margin:20px 0;">
            ${percentage >= 80 ? 'ç´ æ™´ã‚‰ã—ã„ï¼æ­´å²åšå£«ã§ã™ã­ï¼ğŸ†' : 
              percentage >= 60 ? 'ã‚ˆãã§ãã¾ã—ãŸï¼ğŸ“š' : 
              'å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼ğŸ’ª'}
        </div>
        <button class="btn" onclick="location.reload()">ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦</button>
    `;
}

// Enterã‚­ãƒ¼ã§é€ä¿¡
document.getElementById('user-answer').addEventListener('keypress', e => {
    if (e.key === 'Enter') {
        if (document.getElementById('submit-btn').style.display !== 'none') submitAnswer();
        else if (document.getElementById('next-btn').style.display !== 'none') nextQuestion();
    }
});
</script>
</body>
</html>
