<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CSV → Web入力 → AI採点（歴史用語）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Sans","Noto Sans JP",sans-serif;padding:18px;line-height:1.6;}
  h1{margin:0 0 8px;font-size:1.3rem;}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0;}
  textarea{width:100%;min-height:140px;border:1px solid #ddd;padding:8px;border-radius:8px;}
  button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#fafafa;cursor:pointer;}
  button:disabled{opacity:.6;cursor:not-allowed;}
  .small{font-size:.9rem;color:#555;}
  .quiz-area{margin-top:20px;padding:20px;border:1px solid #eee;border-radius:8px;}
  .question-box{font-size:1.2rem;font-weight:bold;margin-bottom:10px;}
  .input-box{display:flex;gap:8px;align-items:center;margin-bottom:10px;}
  .input-box input{flex-grow:1;padding:8px;border-radius:8px;border:1px solid #ddd;}
  .advice{padding:10px;border-radius:8px;border:1px solid #e7eaf0;background:#fbfcff;margin-top:12px;}
  .token-row{display:none;} /* トークン入力欄を非表示にする */
  .spinner{display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid #999;border-top-color:transparent;animation:spin 0.9s linear infinite;vertical-align:middle;margin-left:8px;}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <h1>CSV → Web入力 → AI採点（歴史用語）</h1>
  <div class="small muted">CSV 形式：<code>question,answer,era,hint</code>（ヘッダー可）。複数正答は <code>|</code> 区切り。</div>

  <div style="margin-top:8px;">
    <label class="file">CSV をファイルから読み込む<input id="file" type="file" accept=".csv,text/csv"></label>
  </div>

  <div style="margin-top:10px;">
    <textarea id="csv">
question,answer,era,hint
鎌倉幕府を開いた人物,源頼朝,中世,征夷大将軍に任じられた
室町幕府を開いた将軍,足利尊氏,中世,建武の新政後に成立
江戸幕府の初代将軍,徳川家康,近世,関ヶ原合戦の勝者
版籍奉還と同時期の改革,廃藩置県,近代,中央集権化
大日本帝国憲法を起草した中心人物,伊藤博文,近代,初代内閣総理大臣
    </textarea>
  </div>

  <div class="controls">
    <button id="load">CSV 読み込み</button>
    <button id="start-quiz" disabled>クイズ開始</button>
  </div>

  <div id="quiz-container" class="quiz-area">
    <p>CSVを読み込んで「クイズ開始」ボタンを押してください。</p>
  </div>

<script>
// データ格納
let quizData = [];
let currentQuestionIndex = 0;

// 要素取得
const csvTextarea = document.getElementById("csv");
const loadButton = document.getElementById("load");
const startButton = document.getElementById("start-quiz");
const quizContainer = document.getElementById("quiz-container");
const fileInput = document.getElementById("file");

// CSVをパース
function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(",");
  return lines.slice(1).map(line => {
    const values = line.split(",");
    const obj = {};
    header.forEach((h, i) => {
      obj[h.trim()] = values[i] ? values[i].trim() : "";
    });
    return obj;
  });
}

// CSVファイル読み込み
fileInput.onchange = (event) => {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      csvTextarea.value = e.target.result;
      loadQuizData();
    };
    reader.readAsText(file);
  }
};

// CSV読み込み
loadButton.onclick = loadQuizData;

function loadQuizData() {
  const text = csvTextarea.value;
  quizData = parseCSV(text);
  if (quizData.length > 0) {
    alert("CSVを読み込みました。問題数: " + quizData.length);
    startButton.disabled = false;
  } else {
    alert("CSVに問題データがありません。");
    startButton.disabled = true;
  }
}

// クイズ開始
startButton.onclick = () => {
  currentQuestionIndex = 0;
  displayQuestion();
};

// 問題表示
function displayQuestion() {
  if (currentQuestionIndex >= quizData.length) {
    quizContainer.innerHTML = "<h2>クイズ終了！</h2><p>全問終了しました。</p>";
    startButton.disabled = true;
    return;
  }

  const q = quizData[currentQuestionIndex];
  quizContainer.innerHTML = `
    <p class="small muted">問題 ${currentQuestionIndex + 1} / ${quizData.length}</p>
    <div class="question-box">${q.question}</div>
    <div class="input-box">
      <input id="user-answer" type="text" placeholder="ここに答えを入力" style="width:100%">
      <button id="grade-ai">AI 採点</button>
    </div>
    <div id="ai-result"></div>
  `;
  document.getElementById("grade-ai").onclick = gradeAI;
}

// AI採点
async function gradeAI() {
  const userAnswer = document.getElementById("user-answer").value.trim();
  const currentQuestion = quizData[currentQuestionIndex];
  const aiResultDiv = document.getElementById("ai-result");
  
  aiResultDiv.innerHTML = "AI 採点中… <span class='spinner'></span>";
  
  try {
    // サーバーの /grade-ai エンドポイントを呼び出す
    const res = await fetch("/grade-ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ userAnswer, currentQuestion })
    });
    
    if (!res.ok) {
        throw new Error(`サーバーエラー: ${res.status} ${res.statusText}`);
    }

    const data = await res.json();
    const outputText = data.advice || "No response";

    // AIの応答をそのまま表示
    aiResultDiv.innerHTML = `<div class="advice">
      <h3>AI先生からの解説</h3>
      <p>${outputText.replace(/\n/g, '<br>')}</p>
      <button id="next-question">次の問題へ</button>
    </div>`;
    
    document.getElementById("next-question").onclick = () => {
      currentQuestionIndex++;
      displayQuestion();
    };

  } catch(e) {
    aiResultDiv.innerHTML = `<div class="advice" style="border-color:red; color:red;">
      <b>AI採点エラー:</b><br> ${e.message}
      <p>サーバーが起動しているか確認してください。</p>
    </div>`;
  }
}
</script>
</body>
</html>