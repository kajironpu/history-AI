<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>歴史クイズAI</title>
<style>
/* 全体的なスタイル */
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:10px; /* 上下左右の余白を削減 */
    color: #333;
}

/* コンテナ：スマホ向けにコンパクト化 */
.container {
    background:white;
    border-radius:16px;
    box-shadow:0 10px 20px rgba(0,0,0,0.1);
    padding:20px; /* 上下左右のパディングを削減 */
    max-width:100%; /* 800px → 100% */
    width:100%;
    text-align:center;
    position:relative;
}

/* ヘッダー：フォントサイズ縮小 */
h1 {
    color:#333;
    margin-bottom:12px;
    font-size:1.8rem; /* 2.5rem → 1.8rem */
    line-height:1.3;
}

/* 時代表示・選択・正解率：縦並びで省スペース */
.header-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 12px; /* 20px → 12px */
}
#era-display {
    font-size: 1.2rem; /* 1.5rem → 1.2rem */
    margin-bottom: 6px;
    color: #555;
    font-weight: bold;
}
.score {
    font-size:1rem; /* 1.2rem → 1rem */
    color:#333;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 6px; /* 10px → 6px */
}
#era-select {
    padding: 8px 12px; /* 10px 14px → 8px 12px */
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 0.95rem; /* 1rem → 0.95rem */
    margin-bottom: 10px; /* 15px → 10px */
}

/* クイズセクション：余白削減 */
.quiz-section {
    margin-top: 15px; /* 30px → 15px */
    margin-bottom:15px; /* 30px → 15px */
}
.question {
    font-size:1.1rem; /* 1.3rem → 1.1rem */
    color:#555;
    margin-bottom:15px; /* 20px → 15px */
    padding:15px; /* 20px → 15px */
    background:#f8f9fa;
    border-radius:8px; /* 10px → 8px */
    border-left:4px solid #667eea; /* 5px → 4px */
    word-wrap: break-word; 
    line-height:1.5;
}
.answer-input {
    width:100%;
    padding:12px; /* 16px → 12px */
    font-size:1rem; /* 1.2rem → 1rem */
    border:2px solid #ddd;
    border-radius:8px; /* 10px → 8px */
    margin-bottom:15px; /* 20px → 15px */
    transition:border-color 0.3s;
}
.answer-input:focus {
    outline:none;
    border-color:#667eea;
}

/* ボタン：サイズ縮小、余白調整 */
.btn-group {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px; /* 12px → 8px */
    margin-top: 10px;
}
.btn {
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    color:white;
    border:none;
    padding:12px 24px; /* 16px 32px → 12px 24px */
    font-size:1rem; /* 1.2rem → 1rem */
    border-radius:20px; /* 25px → 20px */
    cursor:pointer;
    transition:transform 0.3s, box-shadow 0.3s;
}
.btn:hover {
    transform:translateY(-2px);
    box-shadow:0 8px 16px rgba(0,0,0,0.2);
}
.btn:disabled {
    opacity:0.6;
    cursor:not-allowed;
    transform:none;
}

/* 結果表示：フォントサイズ縮小、余白削減 */
.result {
    margin-top:15px; /* 30px → 15px */
    padding:15px; /* 20px → 15px */
    border-radius:8px; /* 10px → 8px */
    text-align:left;
    line-height:1.5; /* 1.6 → 1.5 */
    font-size: 0.95rem; /* 追加 */
    display:none;
}
.result.correct {
    background:#d4edda;
    border:1px solid #c3e6cb;
    color:#155724;
}
.result.incorrect {
    background:#f8d7da;
    border:1px solid #f5c6cb;
    color:#721c24;
}

/* ローディングスピナー：サイズ縮小 */
.loading {
    display:inline-block;
    width:16px; /* 20px → 16px */
    height:16px; /* 20px → 16px */
    border:2px solid #f3f3f3; /* 3px → 2px */
    border-top:2px solid #667eea; /* 3px → 2px */
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-left:6px; /* 10px → 6px */
}
@keyframes spin {
    0% { transform:rotate(0deg); }
    100% { transform:rotate(360deg); }
}

/* 最終結果画面：スマホ向けにコンパクト化 */
.final-result h1 {
    font-size: 2rem; /* 3rem → 2rem */
    margin-bottom: 15px; /* 20px → 15px */
}
.final-result .score {
    font-size: 1.8rem; /* 2.5rem → 1.8rem */
    margin: 20px 0; /* 30px → 20px */
}
.final-result .message {
    font-size: 1.1rem; /* 1.4rem → 1.1rem */
    margin: 15px 0; /* 20px → 15px */
    line-height: 1.4;
}

/* メディアクエリでスマホ対応（さらに最適化） */
@media (max-width: 480px) {
    body {
        padding: 5px;
    }
    .container {
        padding: 15px;
        border-radius: 12px;
    }
    h1 {
        font-size: 1.6rem;
    }
    #era-display {
        font-size: 1.1rem;
    }
    .score {
        gap: 4px;
        font-size: 0.9rem;
    }
    .question {
        font-size: 1rem;
        padding: 12px;
    }
    .answer-input, .btn {
        font-size: 0.95rem;
        padding: 10px 20px;
    }
    .result {
        font-size: 0.9rem;
        padding: 12px;
    }
    .final-result h1 {
        font-size: 1.8rem;
    }
    .final-result .score {
        font-size: 1.6rem;
    }
    .final-result .message {
        font-size: 1rem;
    }
}
</style>
</head>
<body>
<div class="container">
    <h1>🏛️ 歴史クイズAI</h1>

    <div class="header-info">
        <div id="era-display">時代を読み込み中...</div>
        <select id="era-select" onchange="filterByEra()">
            <option value="all">全ての時代</option>
        </select>
    </div>
    
    <div class="score">
        正解率: <span id="accuracy-rate">0% (0/0)</span>
        <span id="remaining-questions"></span>
    </div>

    <div class="quiz-section">
        <div class="question" id="question-text">問題を読み込み中...</div>
        <input type="text" id="user-answer" class="answer-input" placeholder="答えを入力" />
        <div class="btn-group">
            <button id="submit-btn" class="btn" onclick="submitAnswer()">回答</button>
            <button id="next-btn" class="btn" onclick="nextQuestion()" style="display:none;">次へ</button>
        </div>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
let allQuestions = [];
let questions = [];
let currentQuestionIndex = 0;
let correctCount = 0;
let answeredCount = 0;
let eraOrder = [];

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

async function loadQuestionsFromCSV() {
    const response = await fetch('questions.csv');
    let text = await response.text();
    text = text.replace(/^\uFEFF/, '');
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const eraIndex = headers.indexOf('時代');
    const questionIndex = headers.indexOf('問題');
    const answerIndex = headers.indexOf('答え');

    const questions = lines.slice(1)
        .map(line => line.split(',').map(c => c.trim()))
        .filter(cols => cols.length > Math.max(eraIndex, questionIndex, answerIndex))
        .map(cols => ({
            era: cols[eraIndex],
            question: cols[questionIndex],
            answer: cols[answerIndex]
        }));

    eraOrder = [];
    questions.forEach(q => {
        if (!eraOrder.includes(q.era)) {
            eraOrder.push(q.era);
        }
    });
    return questions;
}

document.addEventListener('DOMContentLoaded', async () => {
    allQuestions = await loadQuestionsFromCSV();
    allQuestions = shuffle(allQuestions);
    populateEraSelect();
    questions = [...allQuestions];
    displayCurrentQuestion();
    updateCounters();
});

function populateEraSelect() {
    const select = document.getElementById('era-select');
    eraOrder.forEach(era => {
        const option = document.createElement('option');
        option.value = era;
        option.textContent = era;
        select.appendChild(option);
    });
}

function filterByEra() {
    const selectedEra = document.getElementById('era-select').value;
    if (selectedEra === 'all') questions = [...allQuestions];
    else questions = allQuestions.filter(q => q.era === selectedEra);
    questions = shuffle(questions);
    currentQuestionIndex = 0;
    document.getElementById('era-display').textContent = (selectedEra === 'all' ? '全ての時代' : selectedEra);
    displayCurrentQuestion();
    correctCount = 0;
    answeredCount = 0;
    updateCounters();
}

function displayCurrentQuestion() {
    if(questions.length === 0){
        document.getElementById('question-text').textContent = 'この時代の問題はありません。';
        document.getElementById('submit-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
        return;
    }
    const currentQuestion = questions[currentQuestionIndex];
    document.getElementById('era-display').textContent = currentQuestion.era;
    document.getElementById('question-text').textContent = currentQuestion.question;
    document.getElementById('user-answer').value = '';
    document.getElementById('user-answer').focus();
    document.getElementById('submit-btn').style.display = 'inline-block';
    document.getElementById('next-btn').style.display = 'none';
    document.getElementById('result').style.display = 'none';
}

function updateCounters() {
    const accuracy = answeredCount === 0 ? 0 : Math.round((correctCount / answeredCount) * 100);
    const remaining = questions.length - (currentQuestionIndex + 1);
    
    document.getElementById('accuracy-rate').textContent = `${accuracy}% (${correctCount}/${answeredCount})`;
    document.getElementById('remaining-questions').textContent = `残り${remaining}問`;
}

async function submitAnswer() {
    const userAnswer = document.getElementById('user-answer').value.trim();
    const currentQuestion = questions[currentQuestionIndex];
    const submitBtn = document.getElementById('submit-btn');
    const resultDiv = document.getElementById('result');

    submitBtn.disabled = true;
    submitBtn.innerHTML = '採点中<span class="loading"></span>';

    try {
        const normalize = str => str.replace(/[（）()【】［］「」『』\s]/g,'').normalize('NFKC').toLowerCase();
        const userNorm = normalize(userAnswer);
        const answerNorm = normalize(currentQuestion.answer);
        
        const isExactMatch = userNorm === answerNorm;
        const isPartialMatch = answerNorm.includes(userNorm) || userNorm.includes(answerNorm);
        const isSubstantialMatch = userNorm.length >= 2 && (answerNorm.includes(userNorm) || userNorm.includes(answerNorm));
        
        const isPartialCorrect = isExactMatch || (isPartialMatch && isSubstantialMatch);

        let advice = '';
        const response = await fetch('/api/grade-ai', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ 
                userAnswer, 
                currentQuestion,
                isCorrect: isPartialCorrect,
                normalizedUserAnswer: userNorm,
                normalizedCorrectAnswer: answerNorm
            })
        });
        const result = await response.json();
        
        if(isPartialCorrect){
            advice = result.advice || '✔ 正解です！';
        } else {
            advice = result.advice || `❌ 不正解です。正解: ${currentQuestion.answer}`;
        }

        resultDiv.innerHTML = advice;
        resultDiv.className = 'result ' + (isPartialCorrect ? 'correct' : 'incorrect');
        resultDiv.style.display = 'block';

        if(isPartialCorrect) correctCount++;
        answeredCount++;
        updateCounters();

        submitBtn.style.display = 'none';
        document.getElementById('next-btn').style.display = 'inline-block';
    } catch(e){
        console.error(e);
        resultDiv.innerHTML = `エラー: ${e.message}`;
        resultDiv.className = 'result incorrect';
        resultDiv.style.display = 'block';
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '回答';
    }
}

function nextQuestion() {
    currentQuestionIndex++;
    if(currentQuestionIndex >= questions.length){
        showFinalResult();
    } else {
        displayCurrentQuestion();
        updateCounters();
    }
}

function showFinalResult() {
    const container = document.querySelector('.container');
    const percentage = answeredCount === 0 ? 0 : Math.round((correctCount / answeredCount) * 100);
    
    container.innerHTML = `
        <div class="final-result">
            <h1>🎉 完了！</h1>
            <div class="score">
                ${correctCount}/${answeredCount}問正解 (${percentage}%)
            </div>
            <div class="message">
                ${percentage >= 80 ? '歴史博士！🏆' : 
                  percentage >= 60 ? 'よくできました📚' : 
                  '復習して再挑戦💪'}
            </div>
            <button class="btn" onclick="location.reload()">再挑戦</button>
        </div>
    `;
}

document.getElementById('user-answer').addEventListener('keypress', e=>{
    if(e.key==='Enter'){
        if(document.getElementById('submit-btn').style.display!=='none') submitAnswer();
        else if(document.getElementById('next-btn').style.display!=='none') nextQuestion();
    }
});
</script>
</body>
</html>
