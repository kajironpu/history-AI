<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ­´å²ã‚¯ã‚¤ã‚ºAI</title>
<style>
/* å…¨ä½“ */
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:center;
    padding:0;
    color:#333;
}

/* ã‚³ãƒ³ãƒ†ãƒŠ */
.container {
    background:white;
    border-radius:15px;
    box-shadow:0 10px 20px rgba(0,0,0,0.1);
    width:95%;
    max-width:500px;
    height:95vh;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
    padding:15px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
h1 {
    font-size:1.8rem;
    text-align:center;
    margin-bottom:5px;
}
.header-info {
    display:flex;
    flex-direction:column;
    align-items:center;
    margin-bottom:5px;
}
#era-display {
    font-size:1.2rem;
    font-weight:bold;
    margin-bottom:5px;
}
#era-select {
    font-size:1rem;
    padding:6px 10px;
    border-radius:8px;
    border:1px solid #ddd;
}

/* ã‚¹ã‚³ã‚¢ */
.score {
    font-size:1rem;
    display:flex;
    justify-content:space-between;
    padding:0 10px;
    margin-bottom:5px;
}

/* ã‚¯ã‚¤ã‚ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.quiz-section {
    flex:1 1 auto; /* ä½™ç™½ã‚’ç¢ºä¿ */
    display:flex;
    flex-direction:column;
}
.question {
    flex:1 1 auto;
    font-size:1.1rem;
    padding:10px;
    border-radius:8px;
    border-left:4px solid #667eea;
    background:#f8f9fa;
    overflow-y:auto; /* é•·æ–‡ã¯å†…éƒ¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    margin-bottom:10px;
}
.answer-input {
    font-size:1rem;
    padding:10px;
    border-radius:8px;
    border:1px solid #ddd;
    width:100%;
    margin-bottom:10px;
}

/* ãƒœã‚¿ãƒ³ */
.btn-group {
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin-bottom:5px;
}
.btn {
    flex:1;
    font-size:1rem;
    padding:10px 0;
    border-radius:20px;
    background:linear-gradient(135deg,#667eea,#764ba2);
    color:white;
    border:none;
    cursor:pointer;
}
.btn:hover {
    transform:translateY(-1px);
    box-shadow:0 5px 10px rgba(0,0,0,0.2);
}
.btn:disabled {
    opacity:0.6;
    cursor:not-allowed;
}

/* çµæœè¡¨ç¤º */
.result {
    font-size:0.95rem;
    padding:8px;
    border-radius:8px;
    display:none;
    overflow-wrap:break-word;
}
.result.correct { background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
.result.incorrect { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ */
.loading {
    display:inline-block;
    width:18px;
    height:18px;
    border:3px solid #f3f3f3;
    border-top:3px solid #667eea;
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-left:5px;
}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* æœ€çµ‚çµæœ */
.final-result h1 { font-size:2rem; margin-bottom:10px; text-align:center; }
.final-result .score { font-size:1.5rem; margin:10px 0; text-align:center; }
.final-result .message { font-size:1rem; margin:10px 0; text-align:center; }

/* ã‚¹ãƒãƒ›å¾®èª¿æ•´ */
@media (max-width:480px) {
    h1 { font-size:1.5rem; }
    #era-display { font-size:1rem; }
    .score { font-size:0.9rem; }
    .question { font-size:1rem; }
    .answer-input { font-size:0.95rem; }
    .btn { font-size:0.95rem; }
}
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ›ï¸ æ­´å²ã‚¯ã‚¤ã‚ºAI</h1>

    <div class="header-info">
        <div id="era-display">æ™‚ä»£ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <select id="era-select" onchange="filterByEra()">
            <option value="all">å…¨ã¦ã®æ™‚ä»£</option>
        </select>
    </div>

    <div class="score">
        <span>æ­£è§£ç‡: <span id="accuracy-rate">0% (0/0)</span></span>
        <span id="remaining-questions">æ®‹ã‚Š0å•</span>
    </div>

    <div class="quiz-section">
        <div class="question" id="question-text">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <input type="text" id="user-answer" class="answer-input" placeholder="ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
        <div class="btn-group">
            <button id="submit-btn" class="btn" onclick="submitAnswer()">å›ç­”ã™ã‚‹</button>
            <button id="next-btn" class="btn" onclick="nextQuestion()" style="display:none;">æ¬¡ã®å•é¡Œ</button>
        </div>
    </div>

    <div id="result" class="result"></div>
</div>

<script>
let allQuestions=[], questions=[], currentQuestionIndex=0, correctCount=0, answeredCount=0, eraOrder=[];

function shuffle(array){ for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()* (i+1));[array[i],array[j]]=[array[j],array[i]];} return array;}

async function loadQuestionsFromCSV(){
    const response=await fetch('questions.csv');
    let text=await response.text();
    text=text.replace(/^\uFEFF/,'');
    const lines=text.trim().split('\n');
    const headers=lines[0].split(',').map(h=>h.trim());
    const eraIndex=headers.indexOf('æ™‚ä»£');
    const questionIndex=headers.indexOf('å•é¡Œ');
    const answerIndex=headers.indexOf('ç­”ãˆ');
    const questions=lines.slice(1).map(line=>line.split(',').map(c=>c.trim()))
        .filter(cols=>cols.length>Math.max(eraIndex,questionIndex,answerIndex))
        .map(cols=>({era:cols[eraIndex], question:cols[questionIndex], answer:cols[answerIndex]}));
    eraOrder=[];
    questions.forEach(q=>{if(!eraOrder.includes(q.era)) eraOrder.push(q.era);});
    return questions;
}

document.addEventListener('DOMContentLoaded', async()=>{
    allQuestions=await loadQuestionsFromCSV();
    allQuestions=shuffle(allQuestions);
    populateEraSelect();
    questions=[...allQuestions];
    displayCurrentQuestion();
    updateCounters();
});

function populateEraSelect(){
    const select=document.getElementById('era-select');
    eraOrder.forEach(era=>{const option=document.createElement('option'); option.value=era; option.textContent=era; select.appendChild(option);});
}

function filterByEra(){
    const selectedEra=document.getElementById('era-select').value;
    questions= selectedEra==='all'? [...allQuestions]: allQuestions.filter(q=>q.era===selectedEra);
    questions=shuffle(questions);
    currentQuestionIndex=0;
    document.getElementById('era-display').textContent = selectedEra==='all'? 'å…¨ã¦ã®æ™‚ä»£': selectedEra;
    displayCurrentQuestion();
    correctCount=0; answeredCount=0; updateCounters();
}

function displayCurrentQuestion(){
    if(questions.length===0){
        document.getElementById('question-text').textContent='ã“ã®æ™‚ä»£ã®å•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        document.getElementById('submit-btn').style.display='none';
        document.getElementById('next-btn').style.display='none';
        return;
    }
    const currentQuestion=questions[currentQuestionIndex];
    document.getElementById('era-display').textContent=currentQuestion.era;
    document.getElementById('question-text').textContent=currentQuestion.question;
    document.getElementById('user-answer').value='';
    document.getElementById('user-answer').focus();
    document.getElementById('submit-btn').style.display='inline-block';
    document.getElementById('next-btn').style.display='none';
    document.getElementById('result').style.display='none';
}

function updateCounters(){
    const accuracy=answeredCount===0?0:Math.round((correctCount/answeredCount)*100);
    const remaining=questions.length-(currentQuestionIndex+1);
    document.getElementById('accuracy-rate').textContent=`${accuracy}% (${correctCount}/${answeredCount})`;
    document.getElementById('remaining-questions').textContent=`æ®‹ã‚Š${remaining}å•`;
}

async function submitAnswer(){
    const userAnswer=document.getElementById('user-answer').value.trim();
    const currentQuestion=questions[currentQuestionIndex];
    const submitBtn=document.getElementById('submit-btn');
    const resultDiv=document.getElementById('result');
    submitBtn.disabled=true;
    submitBtn.innerHTML='æ¡ç‚¹ä¸­<span class="loading"></span>';
    try{
        const normalize=str=>str.replace(/[ï¼ˆï¼‰()ã€ã€‘ï¼»ï¼½ã€Œã€ã€ã€\s]/g,'').normalize('NFKC').toLowerCase();
        const userNorm=normalize(userAnswer);
        const answerNorm=normalize(currentQuestion.answer);
        const isExactMatch=userNorm===answerNorm;
        const isPartialMatch=answerNorm.includes(userNorm)||userNorm.includes(answerNorm);
        const isSubstantialMatch=userNorm.length>=2&&(answerNorm.includes(userNorm)||userNorm.includes(answerNorm));
        const isPartialCorrect=isExactMatch||(isPartialMatch&&isSubstantialMatch);

        let advice='';
        const response=await fetch('/api/grade-ai',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({userAnswer,currentQuestion,isCorrect:isPartialCorrect,normalizedUserAnswer:userNorm,normalizedCorrectAnswer:answerNorm})
        });
        const result=await response.json();
        advice=isPartialCorrect? (result.advice||'âœ” æ­£è§£ã§ã™ï¼') : (result.advice||`âŒ ä¸æ­£è§£ã§ã™ã€‚æ­£ã—ã„ç­”ãˆ: ${currentQuestion.answer}`);
        resultDiv.innerHTML=advice;
        resultDiv.className='result '+(isPartialCorrect?'correct':'incorrect');
        resultDiv.style.display='block';
        if(isPartialCorrect) correctCount++;
        answeredCount++;
        updateCounters();
        submitBtn.style.display='none';
        document.getElementById('next-btn').style.display='inline-block';
    }catch(e){
        console.error(e);
        resultDiv.innerHTML=`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`;
        resultDiv.className='result incorrect';
        resultDiv.style.display='block';
    }finally{
        submitBtn.disabled=false;
        submitBtn.innerHTML='å›ç­”ã™ã‚‹';
    }
}

function nextQuestion(){
    currentQuestionIndex++;
    if(currentQuestionIndex>=questions.length){ showFinalResult(); } 
    else{ displayCurrentQuestion(); updateCounters(); }
}

function showFinalResult(){
    const container=document.querySelector('.container');
    const percentage=answeredCount===0?0:Math.round((correctCount/answeredCount)*100);
    container.innerHTML=`
        <div class="final-result">
            <h1>ğŸ‰ ã‚¯ã‚¤ã‚ºå®Œäº†ï¼</h1>
            <div class="score">æ­£è§£æ•°: ${correctCount}/${answeredCount} (${percentage}%)</div>
            <div class="message">${percentage>=80?'ç´ æ™´ã‚‰ã—ã„ï¼æ­´å²åšå£«ã§ã™ã­ï¼ğŸ†':percentage>=60?'ã‚ˆãã§ãã¾ã—ãŸï¼ğŸ“š':'å¾©ç¿’ã—ã¦å†æŒ‘æˆ¦ã—ã¦
